<script>
  // URL de tu Web App (termina en /exec)
  const API_URL = "https://script.google.com/macros/s/AKfycbyL54IEYlM-jJJiq50QQtf3dvHIihLWQT6BPUGdf709FiH3bsW-Pz1Mgr7myvFyU4kTIQ/exec";

  const $ = (q) => document.querySelector(q);

  // Enter en el input
  document.addEventListener('DOMContentLoaded', () => {
    const inp = $('#trk');
    if (inp) inp.addEventListener('keydown', (e) => { if (e.key === 'Enter') buscar(); });
  });

  // ==> MISMA LLAMADA QUE TU HTML ANTERIOR (JSONP + callback=mostrar)
  function buscar() {
    const t = ($('#trk').value || '').trim().toUpperCase();
    const res = $('#res');
    if (!t) {
      res.className = 'empty';
      res.innerHTML = '⚠️ Escribe un número de tracking.';
      return;
    }
    res.className = 'empty';
    res.innerHTML = '<div style="display:flex;gap:10px;align-items:center"><div style="width:18px;height:18px;border:3px solid #1e293b;border-top-color:#60a5fa;border-radius:50%;animation:spin .8s linear infinite"></div><span class="muted">Consultando…</span></div>';

    // Limpia script JSONP previo
    const old = document.getElementById('jsonp-call');
    if (old) old.remove();

    // Usamos callback fijo 'mostrar' (igual que tu versión anterior)
    window.mostrar = mostrar; // asegúrate de exponerla en global
    const url = API_URL
      + '?tracking=' + encodeURIComponent(t)
      + '&ua=' + encodeURIComponent(navigator.userAgent || '')
      + '&ref=' + encodeURIComponent(document.referrer || location.origin || '')
      + '&callback=mostrar'
      + '&_=' + Date.now();

    const s = document.createElement('script');
    s.id = 'jsonp-call';
    s.src = url;
    s.onerror = () => {
      res.className = 'empty';
      res.innerHTML = '❌ Error de conexión (revisa permisos del Web App / URL /exec).';
    };
    document.body.appendChild(s);
  }

  // ==> MISMA FORMA DE PINTAR QUE TU VERSIÓN (primer resultado)
  function mostrar(api) {
    const d = $('#res');
    if (!api || !api.ok) {
      d.className = 'empty';
      d.innerHTML = '❌ Error en la API.';
      return;
    }
    if (!api.results || !api.results.length) {
      d.className = 'empty';
      d.innerHTML = '❌ Envío no encontrado. Verifica el número.';
      return;
    }
    const x = api.results[0];
    d.className = '';
    d.innerHTML = `
      <table role="table" aria-label="Resultado de rastreo">
        <thead><tr>
          <th>Tracking</th><th># de almacén</th><th>Peso</th><th>Estado</th><th>Ubicación</th><th>Fecha</th>
        </tr></thead>
        <tbody><tr>
          <td><code>${esc(x.tracking)}</code></td>
          <td>${esc(x.almacen)}</td>
          <td>${esc(x.peso)}</td>
          <td>${esc(x.estado)}</td>
          <td>${esc(x.ubicacion)}</td>
          <td>${x.fecha ? esc(new Date(x.fecha).toLocaleString()) : 'Sin fecha'}</td>
        </tr></tbody>
      </table>`;
  }

  function esc(s){ return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
</script>

